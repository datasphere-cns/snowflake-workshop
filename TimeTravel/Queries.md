# Snowflake Admin: Top 10 SQL Queries para Monitoreo y Administración

Este documento contiene 10 consultas esenciales para administradores de Snowflake, orientadas al monitoreo de consumo, seguridad, rendimiento y uso general del sistema.

---

## 1. Últimos inicios de sesión por usuario
```sql
SELECT 
  LOGIN_NAME,
  CREATED_ON,
  LAST_SUCCESS_LOGIN
 FROM SNOWFLAKE.ACCOUNT_USAGE.USERS
ORDER BY LAST_SUCCESS_LOGIN DESC
LIMIT 20;
```

---

## 2. Consultas fallidas recientes
```sql
SELECT 
  QUERY_ID,
  USER_NAME,
  ERROR_CODE,
  ERROR_MESSAGE,
  START_TIME,
  QUERY_TEXT
FROM SNOWFLAKE.ACCOUNT_USAGE.QUERY_HISTORY
WHERE ERROR_CODE IS NOT NULL
  AND START_TIME >= DATEADD(DAY, -7, CURRENT_TIMESTAMP)
ORDER BY START_TIME DESC
LIMIT 20;
```

---

## 3. Consultas más largas en duración
```sql
SELECT 
  QUERY_ID,
  USER_NAME,
  EXECUTION_TIME/1000 AS SEGUNDOS,
  START_TIME,
  QUERY_TEXT
FROM SNOWFLAKE.ACCOUNT_USAGE.QUERY_HISTORY
WHERE START_TIME >= DATEADD(DAY, -7, CURRENT_TIMESTAMP)
ORDER BY EXECUTION_TIME DESC
LIMIT 10;
```

---

## 4. Eventos de warehouse
```sql
SELECT 
  WAREHOUSE_NAME,
  EVENT_NAME,
  TIMESTAMP,
  USER_NAME
 FROM SNOWFLAKE.ACCOUNT_USAGE.WAREHOUSE_EVENTS_HISTORY
WHERE TIMESTAMP >= DATEADD(DAY, -7, CURRENT_TIMESTAMP)
ORDER BY TIMESTAMP DESC;
```

---

## 5. Consumo de créditos por rol
```sql
SELECT 
  ROLE_NAME,
  SUM(CREDITS_USED_CLOUD_SERVICES) AS TOTAL_CREDITOS
FROM SNOWFLAKE.ACCOUNT_USAGE.QUERY_HISTORY 
WHERE START_TIME >= DATEADD(DAY, -30, CURRENT_TIMESTAMP)
GROUP BY ROLE_NAME
ORDER BY TOTAL_CREDITOS DESC;
```

---

## 6. Permisos asignados por usuario
```sql
SELECT 
  CREATED_ON,
  DELETED_ON,
  ROLE,
  GRANTED_TO,
  GRANTEE_NAME
 FROM SNOWFLAKE.ACCOUNT_USAGE.GRANTS_TO_USERS
ORDER BY ROLE;
```

---

## 7. Tablas más grandes por tamaño
```sql
SELECT 
  TABLE_CATALOG, 
  TABLE_SCHEMA, 
  TABLE_NAME, 
  ACTIVE_BYTES / 1024 / 1024 AS TAMANO_MB
 FROM SNOWFLAKE.ACCOUNT_USAGE.TABLE_STORAGE_METRICS 
ORDER BY ACTIVE_BYTES DESC
LIMIT 10;
```

---

## 8. Fechas de última modificación de tablas
```sql
SELECT 
  TABLE_CATALOG, 
  TABLE_SCHEMA, 
  TABLE_NAME, 
  LAST_ALTERED
FROM SNOWFLAKE.ACCOUNT_USAGE.TABLES
ORDER BY LAST_ALTERED DESC
LIMIT 20;
```

---

## 9. Usuarios con MFA desactivado
```sql
SELECT 
  NAME AS USER_NAME,
  HAS_PASSWORD,
  DEFAULT_ROLE,
  DISABLED,
  LAST_SUCCESS_LOGIN
FROM SNOWFLAKE.ACCOUNT_USAGE.USERS
WHERE HAS_PASSWORD = TRUE
ORDER BY LAST_SUCCESS_LOGIN DESC;
```

---

## 10. Actividad de data sharing (shares activos)
```sql
SELECT 
  SHARE_NAME,
  CREATED,
  CREATED_BY,
  IS_MANAGED,
  COMMENT
FROM SNOWFLAKE.ACCOUNT_USAGE.SHARES
ORDER BY CREATED DESC;
```

---
